input {
  beats {
    port => 5044
  }
  tcp {
    port => 5000
    codec => json_lines
  }
}

filter {
  # Try to parse custodian output files if they arrive as JSON
  if [fileset][module] == "custodian" or [source] =~ "custodian-output" {
    json {
      source => "message"
      target => "custodian"
      remove_field => ["message"]
      add_tag => ["custodian"]
    }
  }

  # Normalize timestamp if present
  if [custodian][time] {
    date {
      match => ["[custodian][time]", "ISO8601", "yyyy-MM-dd'T'HH:mm:ss.SSSZ"]
      target => "@timestamp"
      remove_field => ["[custodian][time]"]
    }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "custodian-%{+YYYY.MM.dd}"
    manage_template => true
    ilm_enabled => false
  }
  stdout { codec => rubydebug }
}
